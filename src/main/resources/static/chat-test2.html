<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>STOMP Chat í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</title>
    <script src="https://cdn.jsdelivr.net/npm/sockjs-client@1/dist/sockjs.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/stompjs@2.3.3/lib/stomp.min.js"></script>
    <style>
        body {
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        input, button {
            margin: 5px;
        }

        #messages {
            margin-top: 20px;
            border: 1px solid #ccc;
            padding: 10px;
            height: 300px;
            overflow-y: auto;
            background: #f9f9f9;
        }
    </style>
</head>
<body>
<h2>STOMP Chat í…ŒìŠ¤íŠ¸ í´ë¼ì´ì–¸íŠ¸</h2>

<label>íŒŒí‹° ID: <input type="number" id="partyId" value="1"/></label><br/>
<label>ì‚¬ìš©ì ID: <input type="number" id="userId" value="5"/></label><br/>

<button onclick="enterAndConnect()">ì…ì¥ + ì—°ê²°</button>
<button onclick="disconnect()">ì—°ê²° í•´ì œ</button>
<br/>

<label>ë©”ì‹œì§€: <input type="text" id="messageInput"/></label>
<button onclick="sendMessage()">ë³´ë‚´ê¸°</button>

<div id="messages"></div>

<script>
    const partyId = document.getElementById("partyId").value;
    userId = parseInt(document.getElementById("userId").value, 10);  // ì‚¬ìš©ì IDë¥¼ numberë¡œ ë³€í™˜
    memberId = userId;  // memberIdëŠ” ì‚¬ìš©ì IDì™€ ë™ì¼í•˜ê²Œ ì„¤ì •

    function enterAndConnect() {
        const partyId = document.getElementById("partyId").value;
        userId = document.getElementById("userId").value;  // ì‚¬ìš©ì IDë¥¼ ì „ì—­ ë³€ìˆ˜ì— í• ë‹¹
        memberId = userId;  // memberIdëŠ” ì‚¬ìš©ì IDì™€ ë™ì¼í•˜ê²Œ ì„¤ì •

        fetch(`http://localhost:8080/api/chat/enter/${partyId}`, {
            method: "POST",
            headers: {
                "Content-Type": "application/json",
                "X-USER-ID": userId   // ğŸ‘‰ ë°±ì—”ë“œì—ì„œ ì‚¬ìš© ì‹œ ì»¤ìŠ¤í…€ í—¤ë”ë¡œ ì²˜ë¦¬ ê°€ëŠ¥
            }
        })
            .then(res => res.json())
            .then(data => {
                log("âœ… ì…ì¥ ì„±ê³µ: " + JSON.stringify(data));
                connectStomp(partyId);
            })
            .catch(err => {
                log("âŒ ì…ì¥ ì‹¤íŒ¨: " + err);
            });
    }

    function connectStomp(partyId) {
        const socket = new SockJS("http://localhost:8080/ws");  // WebSocket URL
        stompClient = Stomp.over(socket);

        stompClient.connect({}, function (frame) {
            log("ğŸŸ¢ STOMP ì—°ê²°ë¨");

            // STOMP êµ¬ë…
            stompClient.subscribe(`/topic/chat/party/${partyId}`, function (msg) {
                log("ğŸ“¥ ë©”ì‹œì§€: " + msg.body);
            });

            stompClient.subscribe(`/topic/chat/party/${partyId}/members`, function (msg) {
                log("ğŸ‘¥ ë©¤ë²„ ê°±ì‹ : " + msg.body);
            });
        }, function (error) {
            log("âŒ STOMP ì—°ê²° ì‹¤íŒ¨: " + error);
        });
    }

    function disconnect() {
        const partyId = document.getElementById("partyId").value;

        // ë¨¼ì € í‡´ì¥ ìš”ì²­
        fetch(`http://localhost:8080/api/chat/leave/${partyId}`, {
            method: "DELETE",
            headers: {
                "Content-Type": "application/json",
                "X-USER-ID": userId
            }
        })
            .then(res => {
                if (!res.ok) throw new Error("í‡´ì¥ ì‹¤íŒ¨");
                log("ğŸšª í‡´ì¥ ìš”ì²­ ì™„ë£Œ");
            })
            .catch(err => {
                log("âŒ í‡´ì¥ ìš”ì²­ ì‹¤íŒ¨: " + err);
            })
            .finally(() => {
                // STOMP ì—°ê²° í•´ì œ
                if (stompClient) {
                    stompClient.disconnect(() => {
                        log("ğŸ”´ STOMP ì—°ê²° í•´ì œë¨");
                    });
                }
            });
    }

    function sendMessage() {
        const partyId = document.getElementById("partyId").value;
        const message = document.getElementById("messageInput").value;

        if (!stompClient || !stompClient.connected) {
            log("âŒ STOMP ì—°ê²°ì´ ì•ˆ ë¨! ë©”ì‹œì§€ë¥¼ ë³´ë‚¼ ìˆ˜ ì—†ìŒ.");
            return;
        }

        console.log("ë©¤ë²„ ID", memberId)
        stompClient.send(`/app/chat.send/${partyId}/member/${memberId}`, {}, JSON.stringify(message));
        log("ğŸ“¤ ë³´ë‚¸ ë©”ì‹œì§€: " + JSON.stringify(messagePayload));
    }

    function log(message) {
        const messagesDiv = document.getElementById("messages");
        messagesDiv.innerHTML += `<div>${message}</div>`;
        messagesDiv.scrollTop = messagesDiv.scrollHeight;
    }
</script>
</body>
</html>
